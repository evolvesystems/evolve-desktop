stages:
  - build

variables:
  GIT_SUBMODULE_STRATEGY: recursive

# Build for Linux
build-linux:
  stage: build
  image: ubuntu:22.04
  tags:
    - docker
  before_script:
    - apt-get update
    - apt-get install -y curl build-essential libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
    - curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    - apt-get install -y nodejs
    - curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
    - source $HOME/.cargo/env
  script:
    - npm ci
    - npm run tauri build
  artifacts:
    paths:
      - src-tauri/target/release/bundle/deb/*.deb
      - src-tauri/target/release/bundle/appimage/*.AppImage
      - src-tauri/target/release/bundle/rpm/*.rpm
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v/'
    - if: '$CI_PIPELINE_SOURCE == "web"'

# Build for Windows
build-windows:
  stage: build
  tags:
    - windows
  before_script:
    - choco install nodejs rust -y
    - $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")
  script:
    - npm ci
    - npm run tauri build
  artifacts:
    paths:
      - src-tauri/target/release/bundle/msi/*.msi
      - src-tauri/target/release/bundle/nsis/*.exe
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v/'
    - if: '$CI_PIPELINE_SOURCE == "web"'

# Build for macOS Intel
build-macos-intel:
  stage: build
  tags:
    - macos
  before_script:
    - brew install node rustup
    - rustup-init -y
    - source $HOME/.cargo/env
    - rustup target add x86_64-apple-darwin
  script:
    - npm ci
    - npm run tauri build -- --target x86_64-apple-darwin
  artifacts:
    paths:
      - src-tauri/target/x86_64-apple-darwin/release/bundle/dmg/*.dmg
      - src-tauri/target/x86_64-apple-darwin/release/bundle/macos/*.app
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v/'
    - if: '$CI_PIPELINE_SOURCE == "web"'

# Build for macOS Apple Silicon
build-macos-arm:
  stage: build
  tags:
    - macos
  before_script:
    - brew install node rustup
    - rustup-init -y
    - source $HOME/.cargo/env
    - rustup target add aarch64-apple-darwin
  script:
    - npm ci
    - npm run tauri build -- --target aarch64-apple-darwin
  artifacts:
    paths:
      - src-tauri/target/aarch64-apple-darwin/release/bundle/dmg/*.dmg
      - src-tauri/target/aarch64-apple-darwin/release/bundle/macos/*.app
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v/'
    - if: '$CI_PIPELINE_SOURCE == "web"'
